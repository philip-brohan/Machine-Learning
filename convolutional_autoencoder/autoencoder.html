
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>A convolutional autoencoder &#8212; Machine Learning Experiments</title>
    <link rel="stylesheet" href="../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="The ML_Utilities package: Functions for data loading and normalisation" href="../package/ML_Utilities.html" />
    <link rel="prev" title="A deep autoencoder" href="../deep_autoencoder/autoencoder.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../package/ML_Utilities.html" title="The ML_Utilities package: Functions for data loading and normalisation"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../deep_autoencoder/autoencoder.html" title="A deep autoencoder"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">ML Experiments</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/Weather-Network.png" alt="Logo"/>
            </a></p>
<h3><a href="../index.html">Table of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../prepare_data/prepare_data.html">Getting climate data into TensorFlow</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../simple_autoencoder/autoencoder.html">Getting started - a simple autoencoder</a></li>
<li class="toctree-l1"><a class="reference internal" href="../autoencoder_perturbations/perturbations.html">Perturbing the simple autoencoder</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deep_autoencoder/autoencoder.html">A deep autoencoder</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">A convolutional autoencoder</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../package/ML_Utilities.html">ML Utilities package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../credits.html">Small Print</a></li>
</ul>
<h3><a href="https://github.com/philip-brohan/Machine-Learning">Get the source code</a></h3>

<a href="https://github.com/philip-brohan/Machine-Learning"
           rel="nofollow">Github source repository</a>

<h3>Found a bug, or have a suggestion?</h3>

Please <a href="https://github.com/philip-brohan/Machine-Learning/issues/new">raise an issue</a>.
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="a-convolutional-autoencoder">
<h1>A convolutional autoencoder<a class="headerlink" href="#a-convolutional-autoencoder" title="Permalink to this headline">¶</a></h1>
<p>Again inspired by <a class="reference external" href="https://www.kaggle.com/vikramtiwari/autoencoders-using-tf-keras-mnist">Vikram Tiwari’s tf.keras Autoencoder page</a>, we can try a <a class="reference external" href="https://en.wikipedia.org/wiki/Convolutional_neural_network">convolutional</a> autoencoder. Like the <a class="reference internal" href="../deep_autoencoder/autoencoder.html"><span class="doc">deep autoencoder</span></a>, this has several hidden layers and Leaky-ReLU activations, but the layers are convolutional, rather than fully connected.</p>
<p>Convolutional layers look at spatially-connected clusters of grid-cells together. This introduces a complication for maps of geospatial data, as they have periodic boundary conditions in longitude, and complications at the poles. Also, convolutional layers are usually paired with pooling layers, and an autoencoder using pooling and upsampling requires a grid resolution which divides exactly by the amount of pooling - this example has 3 2x2 pooling layers, so we need both x and y field sizes to be divisible by 8 (2^3). To deal with this I have <a class="reference external" href="https://www.tensorflow.org/alpha/guide/keras/custom_layers_and_models">written new layers</a> to add and remove periodic-boundary-condition padding along the longitude split, and to resize the data grids. (I’m not worrying about the poles for the moment).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="c1"># Convolutional autoencoder for 20CR prmsl fields.</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">ML_Utilities</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="c1"># How many epochs to train for</span>
<span class="n">n_epochs</span><span class="o">=</span><span class="mi">50</span>

<span class="c1"># Create TensorFlow Dataset object from the prepared training data</span>
<span class="p">(</span><span class="n">tr_data</span><span class="p">,</span><span class="n">n_steps</span><span class="p">)</span> <span class="o">=</span> <span class="n">ML_Utilities</span><span class="o">.</span><span class="n">dataset</span><span class="p">(</span><span class="n">purpose</span><span class="o">=</span><span class="s1">&#39;training&#39;</span><span class="p">,</span>
                                         <span class="n">source</span><span class="o">=</span><span class="s1">&#39;20CR2c&#39;</span><span class="p">,</span>
                                         <span class="n">variable</span><span class="o">=</span><span class="s1">&#39;prmsl&#39;</span><span class="p">)</span>
<span class="n">tr_data</span> <span class="o">=</span> <span class="n">tr_data</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">n_epochs</span><span class="p">)</span>

<span class="c1"># Need to reshape the data to have both dimensions divisible by 8 (3*2-fold pool).</span>
<span class="c1"># Also produce a tuple (source,target) for model</span>
<span class="k">def</span> <span class="nf">to_model</span><span class="p">(</span><span class="n">ict</span><span class="p">):</span>
   <span class="n">ict</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ict</span><span class="p">,[</span><span class="mi">91</span><span class="p">,</span><span class="mi">180</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
   <span class="c1">#ict=tf.image.resize_images(ict, (32, 64),</span>
   <span class="c1">#                           align_corners=True)</span>
   <span class="k">return</span><span class="p">(</span><span class="n">ict</span><span class="p">,</span><span class="n">ict</span><span class="p">)</span>
<span class="n">tr_data</span> <span class="o">=</span> <span class="n">tr_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">to_model</span><span class="p">)</span>
<span class="n">tr_data</span> <span class="o">=</span> <span class="n">tr_data</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Similar dataset from the prepared test data</span>
<span class="p">(</span><span class="n">tr_test</span><span class="p">,</span><span class="n">test_steps</span><span class="p">)</span> <span class="o">=</span> <span class="n">ML_Utilities</span><span class="o">.</span><span class="n">dataset</span><span class="p">(</span><span class="n">purpose</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span>
                                            <span class="n">source</span><span class="o">=</span><span class="s1">&#39;20CR2c&#39;</span><span class="p">,</span>
                                            <span class="n">variable</span><span class="o">=</span><span class="s1">&#39;prmsl&#39;</span><span class="p">)</span>
<span class="n">tr_test</span> <span class="o">=</span> <span class="n">tr_test</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">n_epochs</span><span class="p">)</span>
<span class="n">tr_test</span> <span class="o">=</span> <span class="n">tr_test</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">to_model</span><span class="p">)</span>
<span class="n">tr_test</span> <span class="o">=</span> <span class="n">tr_test</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Need to resize data so it&#39;s dimensions are a multiple of 8 (3*2-fold pool)</span>
<span class="k">class</span> <span class="nc">ResizeLayer</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Layer</span><span class="p">):</span>
   <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
      <span class="nb">super</span><span class="p">(</span><span class="n">ResizeLayer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">resize_newsize</span> <span class="o">=</span> <span class="n">newsize</span>
   <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resize_images</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">resize_newsize</span><span class="p">,</span>
                                    <span class="n">align_corners</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
   <span class="k">def</span> <span class="nf">get_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;newsize&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">resize_newsize</span><span class="p">}</span>

<span class="c1"># Padding and pruning functions for periodic boundary conditions</span>
<span class="k">class</span> <span class="nc">LonPadLayer</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Layer</span><span class="p">):</span>
   <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
      <span class="nb">super</span><span class="p">(</span><span class="n">LonPadLayer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lon_index</span> <span class="o">=</span> <span class="n">index</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lon_padding</span> <span class="o">=</span> <span class="n">padding</span>
   <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_shape</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lon_tile_spec</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">input_shape</span><span class="p">))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lon_tile_spec</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lon_index</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="mi">3</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lon_expansion_slice</span><span class="o">=</span><span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">input_shape</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lon_expansion_slice</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lon_index</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span>
                                <span class="n">input_shape</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lon_index</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">lon_padding</span><span class="p">,</span>
                                <span class="n">input_shape</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lon_index</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">lon_padding</span><span class="p">,</span>
                                <span class="kc">None</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lon_expansion_slice</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lon_expansion_slice</span><span class="p">)</span>      
   <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lon_tile_spec</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">lon_expansion_slice</span><span class="p">]</span>
   <span class="k">def</span> <span class="nf">get_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lon_index</span><span class="p">}</span>
      <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;padding&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lon_padding</span><span class="p">}</span>
<span class="k">class</span> <span class="nc">LonPruneLayer</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Layer</span><span class="p">):</span>
   <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
      <span class="nb">super</span><span class="p">(</span><span class="n">LonPruneLayer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lon_index</span> <span class="o">=</span> <span class="n">index</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lon_padding</span> <span class="o">=</span> <span class="n">padding</span>
   <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_shape</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lon_prune_slice</span><span class="o">=</span><span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">input_shape</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lon_prune_slice</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lon_index</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">lon_padding</span><span class="p">,</span>
                                <span class="n">input_shape</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lon_index</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">lon_padding</span><span class="p">,</span>
                                <span class="kc">None</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lon_prune_slice</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lon_prune_slice</span><span class="p">)</span>      
   <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
     <span class="k">return</span> <span class="nb">input</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lon_prune_slice</span><span class="p">]</span>
   <span class="k">def</span> <span class="nf">get_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lon_index</span><span class="p">}</span>
      <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;padding&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lon_padding</span><span class="p">}</span>

<span class="c1"># Input placeholder</span>
<span class="n">original</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">91</span><span class="p">,</span><span class="mi">180</span><span class="p">,</span><span class="mi">1</span><span class="p">,))</span>
<span class="c1"># Resize to have dimesions divisible by 8</span>
<span class="n">resized</span> <span class="o">=</span> <span class="n">ResizeLayer</span><span class="p">(</span><span class="n">newsize</span><span class="o">=</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span><span class="mi">160</span><span class="p">))(</span><span class="n">original</span><span class="p">)</span>
<span class="c1"># Wrap-around in longitude for periodic boundary conditions</span>
<span class="n">padded</span> <span class="o">=</span> <span class="n">LonPadLayer</span><span class="p">(</span><span class="n">padding</span><span class="o">=</span><span class="mi">8</span><span class="p">)(</span><span class="n">resized</span><span class="p">)</span>
<span class="c1"># Encoding layers</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">padded</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
<span class="n">encoded</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>

<span class="c1"># Decoding layers</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">encoded</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">UpSampling2D</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">UpSampling2D</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">UpSampling2D</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))(</span><span class="n">x</span><span class="p">)</span>
<span class="n">decoded</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="c1"># Strip the longitude wrap-around</span>
<span class="n">pruned</span><span class="o">=</span><span class="n">LonPruneLayer</span><span class="p">(</span><span class="n">padding</span><span class="o">=</span><span class="mi">8</span><span class="p">)(</span><span class="n">decoded</span><span class="p">)</span>
<span class="c1"># Restore to original dimensions</span>
<span class="n">outsize</span><span class="o">=</span><span class="n">ResizeLayer</span><span class="p">(</span><span class="n">newsize</span><span class="o">=</span><span class="p">(</span><span class="mi">91</span><span class="p">,</span><span class="mi">180</span><span class="p">))(</span><span class="n">pruned</span><span class="p">)</span>

<span class="c1"># Model relating original to output</span>
<span class="n">autoencoder</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">original</span><span class="p">,</span><span class="n">outsize</span><span class="p">)</span>
<span class="c1"># Choose a loss metric to minimise (RMS)</span>
<span class="c1">#  and an optimiser to use (adadelta)</span>
<span class="n">autoencoder</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;adadelta&#39;</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mean_squared_error&#39;</span><span class="p">)</span>

<span class="c1"># Train the autoencoder</span>
<span class="n">history</span><span class="o">=</span><span class="n">autoencoder</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">tr_data</span><span class="p">,</span>
                <span class="n">epochs</span><span class="o">=</span><span class="n">n_epochs</span><span class="p">,</span>
                <span class="n">steps_per_epoch</span><span class="o">=</span><span class="n">n_steps</span><span class="p">,</span>
                <span class="n">validation_data</span><span class="o">=</span><span class="n">tr_test</span><span class="p">,</span>
                <span class="n">validation_steps</span><span class="o">=</span><span class="n">test_steps</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># One line per epoch</span>

<span class="c1"># Save the model</span>
<span class="n">save_file</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/Machine-Learning-experiments/&quot;</span><span class="o">+</span>
           <span class="s2">&quot;convolutional_autoencoder/&quot;</span><span class="o">+</span>
           <span class="s2">&quot;saved_models/Epoch_</span><span class="si">%04d</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span>
                 <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;SCRATCH&#39;</span><span class="p">),</span><span class="n">n_epochs</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">save_file</span><span class="p">)):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">save_file</span><span class="p">))</span>
<span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">autoencoder</span><span class="p">,</span><span class="n">save_file</span><span class="p">)</span>
<span class="n">history_file</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/Machine-Learning-experiments/&quot;</span><span class="o">+</span>
              <span class="s2">&quot;convolutional_autoencoder/&quot;</span><span class="o">+</span>
              <span class="s2">&quot;saved_models/history_to_</span><span class="si">%04d</span><span class="s2">.pkl&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span>
                 <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;SCRATCH&#39;</span><span class="p">),</span><span class="n">n_epochs</span><span class="p">)</span>
<span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">history_file</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>For representing MSLP fields, convolution is the way to go: this autoencoder works dramatically better than the <a class="reference internal" href="../simple_autoencoder/autoencoder.html"><span class="doc">simple</span></a> or <a class="reference internal" href="../deep_autoencoder/autoencoder.html"><span class="doc">deep</span></a> versions.</p>
<div class="figure align-center" id="id1" style="width: 95%">
<a class="reference internal image-reference" href="../_images/comparison_results.png"><img alt="../_images/comparison_results.png" src="../_images/comparison_results.png" style="width: 95%;" /></a>
<p class="caption"><span class="caption-text">Top, a sample pressure field: Original in red, after passing through the autoencoder in blue.
Bottom, a scatterplot of original v. encoded pressures for the sample field, and a graph of training progress: Loss v. no. of training epochs.</span></p>
</div>
<div class="section" id="script-to-make-the-figure">
<h2>Script to make the figure<a class="headerlink" href="#script-to-make-the-figure" title="Permalink to this headline">¶</a></h2>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../package/ML_Utilities.html" title="The ML_Utilities package: Functions for data loading and normalisation"
             >next</a> |</li>
        <li class="right" >
          <a href="../deep_autoencoder/autoencoder.html" title="A deep autoencoder"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">ML Experiments</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    </div>
  </body>
</html>