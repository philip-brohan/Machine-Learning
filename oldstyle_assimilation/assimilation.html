
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Oldstyle Assimilation &#8212; Machine Learning Experiments</title>
    <link rel="stylesheet" href="../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Making Tensors of pseudo-observations" href="archive_to_Tensor.html" />
    <link rel="prev" title="An all-convolutional autoencoder with an explicit latent space" href="../convolutional_perturbations/latent_space/autoencoder.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="archive_to_Tensor.html" title="Making Tensors of pseudo-observations"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../convolutional_perturbations/latent_space/autoencoder.html" title="An all-convolutional autoencoder with an explicit latent space"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">ML Experiments</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/Weather-Network.png" alt="Logo"/>
            </a></p>
<h3><a href="../index.html">Table of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../prepare_data/prepare_data.html">Getting climate data into TensorFlow</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../simple_autoencoder/autoencoder.html">Getting started - a simple autoencoder</a></li>
<li class="toctree-l1"><a class="reference internal" href="../autoencoder_perturbations/perturbations.html">Perturbing the simple autoencoder</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deep_autoencoder/autoencoder.html">A deep autoencoder</a></li>
<li class="toctree-l1"><a class="reference internal" href="../convolutional_autoencoder/autoencoder.html">A convolutional autoencoder</a></li>
<li class="toctree-l1"><a class="reference internal" href="../convolutional_perturbations/perturbations.html">Perturbing the convolutional autoencoder</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Old-style assimilation</a></li>
<li class="toctree-l1"><a class="reference internal" href="prate/assimilation.html">Old-style assimilation of precipitation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../package/ML_Utilities.html">ML Utilities package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../credits.html">Small Print</a></li>
</ul>
<h3><a href="https://github.com/philip-brohan/Machine-Learning">Get the source code</a></h3>

<a href="https://github.com/philip-brohan/Machine-Learning"
           rel="nofollow">Github source repository</a>

<h3>Found a bug, or have a suggestion?</h3>

Please <a href="https://github.com/philip-brohan/Machine-Learning/issues/new">raise an issue</a>.
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="oldstyle-assimilation">
<h1>Oldstyle Assimilation<a class="headerlink" href="#oldstyle-assimilation" title="Permalink to this headline">¶</a></h1>
<p>The <a class="reference internal" href="../convolutional_autoencoder/autoencoder.html"><span class="doc">convolutional autoencoder</span></a>, works nicely, but it does nothing other than reproduce its input. Can we modify it to make the same output (a 20CRv2c-like MSLP field) from some other input? That would make it a <a class="reference external" href="https://en.wikipedia.org/wiki/Generative_model">Generative Model</a>, and it could become practically useful.</p>
<p>In particular I would like to make a 20CRv2c-like MSLP field from observations of MSLP. This is essentially what <a class="reference external" href="https://www.esrl.noaa.gov/psd/data/20thC_Rean/">20CR</a> does, so a machine learning system trained to do this would be a cheap approximator to the expensive 20CR system. The general idea is to keep the encoder half of the <a class="reference internal" href="../convolutional_autoencoder/autoencoder.html"><span class="doc">convolutional autoencoder</span></a>, but to replace the encoder half - so we are constructing the encoded MSLP state from a set of observations, rather than from the decoded target state, and then decoding that state back into the full MSLP field as before. This is not quite data assimilation as we are not assimilating observations into a forecast prior - but it attacks the same problem. I’m calling it ‘oldstyle assimilation’ as I think it’s essentially what <a class="reference external" href="https://en.wikipedia.org/wiki/Robert_FitzRoy">Fitzroy</a> &amp; co. did with the original <a class="reference external" href="https://digital.nmla.metoffice.gov.uk/collection_86058de1-8d55-4bc5-8305-5698d0bd7e13/">Daily Weather Reports</a>: taking a set of observations directly, and drawing a pressure map based on those observations.</p>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="archive_to_Tensor.html">First we need to make pseudo-observations files for training and validation</a></li>
</ul>
</div>
<p>Then we can train a model to make an MSLP field from the pseudo-observations.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="c1"># Estimate prmsl fields from (simulated) observations with the coverage of</span>
<span class="c1">#  20CRv2c obs in March 1916.</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="c1">#tf.enable_eager_execution()</span>
<span class="kn">from</span> <span class="nn">tensorflow.data</span> <span class="k">import</span> <span class="n">Dataset</span>
<span class="kn">import</span> <span class="nn">ML_Utilities</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="k">import</span> <span class="n">glob</span>

<span class="c1"># How many epochs to train for</span>
<span class="n">n_epochs</span><span class="o">=</span><span class="mi">50</span>

<span class="c1"># File names for the serialised tensors to train on</span>
<span class="n">input_file_dir</span><span class="o">=</span><span class="p">((</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/Machine-Learning-experiments/datasets/&quot;</span><span class="o">+</span>
                 <span class="s2">&quot;20CR2c/prmsl/training/&quot;</span><span class="p">)</span> <span class="o">%</span>
                   <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;SCRATCH&#39;</span><span class="p">))</span>
<span class="n">training_files</span><span class="o">=</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/*.tfd&quot;</span> <span class="o">%</span> <span class="n">input_file_dir</span><span class="p">)</span>
<span class="n">n_steps</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">training_files</span><span class="p">)</span>
<span class="n">train_tfd</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">training_files</span><span class="p">)</span>

<span class="c1"># Create TensorFlow Dataset object from the file names</span>
<span class="n">field_data</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensor_slices</span><span class="p">(</span><span class="n">train_tfd</span><span class="p">)</span>

<span class="c1"># We don&#39;t want the file names, we want their contents, so</span>
<span class="c1">#  add a map to convert from names to contents.</span>
<span class="k">def</span> <span class="nf">load_tensor</span><span class="p">(</span><span class="n">file_name</span><span class="p">):</span>
    <span class="n">sict</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span> <span class="c1"># serialised</span>
    <span class="n">ict</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">parse_tensor</span><span class="p">(</span><span class="n">sict</span><span class="p">,</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">ict</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ict</span><span class="p">,[</span><span class="mi">91</span><span class="p">,</span><span class="mi">180</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">ict</span>

<span class="n">field_data</span> <span class="o">=</span> <span class="n">field_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">load_tensor</span><span class="p">)</span>
<span class="c1"># Use all the data once each epoch</span>
<span class="n">field_data</span> <span class="o">=</span> <span class="n">field_data</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">n_epochs</span><span class="p">)</span>
<span class="n">field_data</span> <span class="o">=</span> <span class="n">field_data</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Same with the test dataset</span>
<span class="n">input_file_dir</span><span class="o">=</span><span class="p">((</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/Machine-Learning-experiments/datasets/&quot;</span><span class="o">+</span>
                 <span class="s2">&quot;20CR2c/prmsl/test/&quot;</span><span class="p">)</span> <span class="o">%</span>
                   <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;SCRATCH&#39;</span><span class="p">))</span>
<span class="n">test_files</span><span class="o">=</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/*.tfd&quot;</span> <span class="o">%</span> <span class="n">input_file_dir</span><span class="p">)</span>
<span class="n">test_steps</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">test_files</span><span class="p">)</span>
<span class="n">test_tfd</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">test_files</span><span class="p">)</span>
<span class="n">field_test_data</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensor_slices</span><span class="p">(</span><span class="n">test_tfd</span><span class="p">)</span>
<span class="n">field_test_data</span> <span class="o">=</span> <span class="n">field_test_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">load_tensor</span><span class="p">)</span>
<span class="n">field_test_data</span> <span class="o">=</span> <span class="n">field_test_data</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">n_epochs</span><span class="p">)</span>
<span class="n">field_test_data</span> <span class="o">=</span> <span class="n">field_test_data</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># That&#39;s the targets - now make a matching dataset of the </span>
<span class="c1">#   station observations.</span>
<span class="c1"># Use the file names from the field files, but repoint them;</span>
<span class="c1">#  also adjust to use the training/test split from the field files</span>
<span class="k">def</span> <span class="nf">load_observations</span><span class="p">(</span><span class="n">file_name</span><span class="p">):</span>
   <span class="c1"># Get the ob tensor file name from the field tensor file name</span>
   <span class="n">file_name</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">strings</span><span class="o">.</span><span class="n">regex_replace</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span>
                                      <span class="s1">&#39;datasets/&#39;</span><span class="p">,</span><span class="s1">&#39;datasets/obs_1916/&#39;</span><span class="p">)</span>
   <span class="n">file_name</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">strings</span><span class="o">.</span><span class="n">regex_replace</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span>
                                      <span class="s1">&#39;test/&#39;</span><span class="p">,</span><span class="s1">&#39;training/&#39;</span><span class="p">)</span>
   <span class="n">file_name</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">strings</span><span class="o">.</span><span class="n">regex_replace</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span>
                                      <span class="s1">&#39;training/2009&#39;</span><span class="p">,</span><span class="s1">&#39;test/2009&#39;</span><span class="p">)</span>
   <span class="n">sict</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span> <span class="c1"># serialised</span>
   <span class="n">ict</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">parse_tensor</span><span class="p">(</span><span class="n">sict</span><span class="p">,</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
   <span class="n">ict</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ict</span><span class="p">,[</span><span class="mi">488</span><span class="p">,])</span>
   <span class="k">return</span> <span class="n">ict</span>
<span class="n">obs_data</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensor_slices</span><span class="p">(</span><span class="n">train_tfd</span><span class="p">)</span>
<span class="n">obs_data</span> <span class="o">=</span> <span class="n">obs_data</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">n_epochs</span><span class="p">)</span>
<span class="n">obs_data</span> <span class="o">=</span> <span class="n">obs_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">load_observations</span><span class="p">)</span>
<span class="n">obs_data</span> <span class="o">=</span> <span class="n">obs_data</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># And the test observations</span>
<span class="n">obs_test_data</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensor_slices</span><span class="p">(</span><span class="n">test_tfd</span><span class="p">)</span>
<span class="n">obs_test_data</span> <span class="o">=</span> <span class="n">obs_test_data</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">n_epochs</span><span class="p">)</span>
<span class="n">obs_test_data</span> <span class="o">=</span> <span class="n">obs_test_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">load_observations</span><span class="p">)</span>
<span class="n">obs_test_data</span> <span class="o">=</span> <span class="n">obs_test_data</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Zip the target and source together for training</span>
<span class="n">training_data</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">zip</span><span class="p">((</span><span class="n">obs_data</span><span class="p">,</span> <span class="n">field_data</span><span class="p">))</span>
<span class="n">test_data</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">zip</span><span class="p">((</span><span class="n">obs_test_data</span><span class="p">,</span> <span class="n">field_test_data</span><span class="p">))</span>

<span class="c1"># Need to resize data so it&#39;s dimensions are a multiple of 8 (3*2-fold pool)</span>
<span class="k">class</span> <span class="nc">ResizeLayer</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Layer</span><span class="p">):</span>
   <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
      <span class="nb">super</span><span class="p">(</span><span class="n">ResizeLayer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">resize_newsize</span> <span class="o">=</span> <span class="n">newsize</span>
   <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resize_images</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">resize_newsize</span><span class="p">,</span>
                                    <span class="n">align_corners</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
   <span class="k">def</span> <span class="nf">get_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;newsize&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">resize_newsize</span><span class="p">}</span>


<span class="c1"># Build the model:</span>
<span class="c1">#   obs-&gt;dense network-&gt;convolutional network-&gt;field</span>

<span class="c1"># Input placeholder</span>
<span class="n">original</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">488</span><span class="p">,))</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.9</span><span class="p">)(</span><span class="n">original</span><span class="p">)</span>

<span class="c1"># Obs processing layers</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">512</span><span class="p">)(</span><span class="n">original</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">512</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>

<span class="c1"># Need to make a 10x20x8 layer for decoding</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1600</span><span class="p">,</span>
    <span class="n">activity_regularizer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">regularizers</span><span class="o">.</span><span class="n">l1</span><span class="p">(</span><span class="mf">10e-5</span><span class="p">))(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
<span class="n">encoded</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Reshape</span><span class="p">(</span><span class="n">target_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">8</span><span class="p">,))(</span><span class="n">x</span><span class="p">)</span>

<span class="c1"># Decoding layers</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">encoded</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">UpSampling2D</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">UpSampling2D</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">UpSampling2D</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))(</span><span class="n">x</span><span class="p">)</span>
<span class="n">decoded</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="n">resized</span><span class="o">=</span><span class="n">ResizeLayer</span><span class="p">(</span><span class="n">newsize</span><span class="o">=</span><span class="p">(</span><span class="mi">91</span><span class="p">,</span><span class="mi">180</span><span class="p">))(</span><span class="n">decoded</span><span class="p">)</span>

<span class="c1"># Model relating observations to field</span>
<span class="n">autoencoder</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">original</span><span class="p">,</span><span class="n">resized</span><span class="p">)</span>
<span class="c1"># Choose a loss metric to minimise (RMS)</span>
<span class="c1">#  and an optimiser to use (adadelta)</span>
<span class="n">autoencoder</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;adadelta&#39;</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mean_squared_error&#39;</span><span class="p">)</span>

<span class="c1"># Train the autoencoder</span>
<span class="n">history</span><span class="o">=</span><span class="n">autoencoder</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">training_data</span><span class="p">,</span>
                <span class="n">epochs</span><span class="o">=</span><span class="n">n_epochs</span><span class="p">,</span>
                <span class="n">steps_per_epoch</span><span class="o">=</span><span class="n">n_steps</span><span class="p">,</span>
                <span class="n">validation_data</span><span class="o">=</span><span class="n">test_data</span><span class="p">,</span>
                <span class="n">validation_steps</span><span class="o">=</span><span class="n">test_steps</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># One line per epoch</span>

<span class="c1"># Save the model</span>
<span class="n">save_file</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/Machine-Learning-experiments/&quot;</span><span class="o">+</span>
           <span class="s2">&quot;oldstyle_assimilation_1916/&quot;</span><span class="o">+</span>
           <span class="s2">&quot;saved_models/Epoch_</span><span class="si">%04d</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span>
                 <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;SCRATCH&#39;</span><span class="p">),</span><span class="n">n_epochs</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">save_file</span><span class="p">)):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">save_file</span><span class="p">))</span>
<span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">autoencoder</span><span class="p">,</span><span class="n">save_file</span><span class="p">)</span>
<span class="n">history_file</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/Machine-Learning-experiments/&quot;</span><span class="o">+</span>
              <span class="s2">&quot;oldstyle_assimilation_1916/&quot;</span><span class="o">+</span>
              <span class="s2">&quot;saved_models/history_to_</span><span class="si">%04d</span><span class="s2">.pkl&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span>
                 <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;SCRATCH&#39;</span><span class="p">),</span><span class="n">n_epochs</span><span class="p">)</span>
<span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">history_file</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>Considering the simplicity and speed of the system, this works none too badly: The target field is fairly well reproduced in regions close to observations, and in regions far from observations, the system reverts to climatology.</p>
<div class="figure align-center" id="id1" style="width: 95%">
<a class="reference internal image-reference" href="oldstyle_assimilation/../../experiments/oldstyle_assimilation/1916_obs_prmsl/validation/comparison_results.png"><img alt="oldstyle_assimilation/../../experiments/oldstyle_assimilation/1916_obs_prmsl/validation/comparison_results.png" src="oldstyle_assimilation/../../experiments/oldstyle_assimilation/1916_obs_prmsl/validation/comparison_results.png" style="width: 95%;" /></a>
<p class="caption"><span class="caption-text">Top, a sample pressure field: Target in red, as reconstructed from observations (black dots) in blue.
Bottom, a scatterplot of target v. reconstructed pressures for the sample field, and a graph of training progress: Loss v. no. of training epochs.</span></p>
</div>
<div class="section" id="script-to-make-the-figure">
<h2>Script to make the figure<a class="headerlink" href="#script-to-make-the-figure" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="c1"># Model training results plot</span>

<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="n">tf</span><span class="o">.</span><span class="n">enable_eager_execution</span><span class="p">()</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="kn">import</span> <span class="nn">IRData.twcr</span> <span class="k">as</span> <span class="nn">twcr</span>
<span class="kn">import</span> <span class="nn">iris</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="kn">import</span> <span class="nn">Meteorographica</span> <span class="k">as</span> <span class="nn">mg</span>

<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">from</span> <span class="nn">matplotlib.backends.backend_agg</span> <span class="k">import</span> <span class="n">FigureCanvasAgg</span> <span class="k">as</span> <span class="n">FigureCanvas</span>
<span class="kn">from</span> <span class="nn">matplotlib.figure</span> <span class="k">import</span> <span class="n">Figure</span>
<span class="kn">import</span> <span class="nn">cartopy</span>
<span class="kn">import</span> <span class="nn">cartopy.crs</span> <span class="k">as</span> <span class="nn">ccrs</span>

<span class="c1"># Normalisation - Pa to mean=0, sd=1 - and back</span>
<span class="k">def</span> <span class="nf">normalise</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
   <span class="n">x</span> <span class="o">-=</span> <span class="mi">101325</span>
   <span class="n">x</span> <span class="o">/=</span> <span class="mi">3000</span>
   <span class="k">return</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">unnormalise</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
   <span class="n">x</span> <span class="o">*=</span> <span class="mi">3000</span>
   <span class="n">x</span> <span class="o">+=</span> <span class="mi">101325</span>
   <span class="k">return</span> <span class="n">x</span>

<span class="k">class</span> <span class="nc">ResizeLayer</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Layer</span><span class="p">):</span>
   <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
      <span class="nb">super</span><span class="p">(</span><span class="n">ResizeLayer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">resize_newsize</span> <span class="o">=</span> <span class="n">newsize</span>
   <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resize_images</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">resize_newsize</span><span class="p">,</span>
                                    <span class="n">align_corners</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
   <span class="k">def</span> <span class="nf">get_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;newsize&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">resize_newsize</span><span class="p">}</span>

<span class="n">year</span><span class="o">=</span><span class="mi">1916</span>
<span class="n">month</span><span class="o">=</span><span class="mi">3</span>
<span class="n">day</span><span class="o">=</span><span class="mi">12</span>
<span class="n">hour</span><span class="o">=</span><span class="mi">6</span>

<span class="c1"># Get the 20CR data</span>
<span class="c1">#ic=twcr.load(&#39;prmsl&#39;,datetime.datetime(2009,3,12,18),</span>
<span class="n">ic</span><span class="o">=</span><span class="n">twcr</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;prmsl&#39;</span><span class="p">,</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span><span class="n">month</span><span class="p">,</span><span class="n">day</span><span class="p">,</span><span class="n">hour</span><span class="p">),</span>
                           <span class="n">version</span><span class="o">=</span><span class="s1">&#39;2c&#39;</span><span class="p">)</span>
<span class="n">ic</span><span class="o">=</span><span class="n">ic</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">iris</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">member</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="c1">#ic=ic.collapsed(&#39;member&#39;, iris.analysis.MEAN)</span>

<span class="c1"># Make the fake observations</span>
<span class="n">obs</span><span class="o">=</span><span class="n">twcr</span><span class="o">.</span><span class="n">load_observations_fortime</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1916</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span>
                                   <span class="n">version</span><span class="o">=</span><span class="s1">&#39;2c&#39;</span><span class="p">)</span>
<span class="n">ensemble</span><span class="o">=</span><span class="p">[]</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">obs</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">ensemble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ic</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span>
                    <span class="p">[(</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Latitude&#39;</span><span class="p">]),</span>
                     <span class="p">(</span><span class="s1">&#39;longitude&#39;</span><span class="p">,</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Longitude&#39;</span><span class="p">])],</span>
                    <span class="n">iris</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">Linear</span><span class="p">())</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
<span class="n">ensemble</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ensemble</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">ensemble</span> <span class="o">=</span> <span class="n">normalise</span><span class="p">(</span><span class="n">ensemble</span><span class="p">)</span>
<span class="n">obs_t</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">convert_to_tensor</span><span class="p">(</span><span class="n">ensemble</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">obs_t</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">obs_t</span><span class="p">,[</span><span class="mi">1</span><span class="p">,</span><span class="mi">488</span><span class="p">])</span>

<span class="c1"># Get the assimilation model</span>
<span class="n">model_save_file</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/Machine-Learning-experiments/&quot;</span><span class="o">+</span>
                 <span class="s2">&quot;oldstyle_assimilation_1916/&quot;</span><span class="o">+</span>
                 <span class="s2">&quot;saved_models/Epoch_</span><span class="si">%04d</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;SCRATCH&#39;</span><span class="p">),</span><span class="mi">50</span><span class="p">)</span>
<span class="n">autoencoder</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">model_save_file</span><span class="p">,</span>
                                       <span class="n">custom_objects</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;ResizeLayer&#39;</span><span class="p">:</span> <span class="n">ResizeLayer</span><span class="p">})</span>

<span class="n">fig</span><span class="o">=</span><span class="n">Figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">9.6</span><span class="p">,</span><span class="mf">10.8</span><span class="p">),</span>  <span class="c1"># 1/2HD</span>
           <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
           <span class="n">facecolor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.88</span><span class="p">,</span><span class="mf">0.88</span><span class="p">,</span><span class="mf">0.88</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
           <span class="n">edgecolor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
           <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
           <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
           <span class="n">subplotpars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
           <span class="n">tight_layout</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">canvas</span><span class="o">=</span><span class="n">FigureCanvas</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

<span class="c1"># Top - map showing original and reconstructed fields</span>
<span class="c1"># Plot the locations of the stations</span>
<span class="n">projection</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">RotatedPole</span><span class="p">(</span><span class="n">pole_longitude</span><span class="o">=</span><span class="mf">180.0</span><span class="p">,</span> <span class="n">pole_latitude</span><span class="o">=</span><span class="mf">90.0</span><span class="p">)</span>
<span class="n">ax_map</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.01</span><span class="p">,</span><span class="mf">0.51</span><span class="p">,</span><span class="mf">0.98</span><span class="p">,</span><span class="mf">0.48</span><span class="p">],</span><span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">)</span>
<span class="n">ax_map</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
<span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span><span class="mi">180</span><span class="p">,</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span><span class="mi">90</span><span class="p">]</span>
<span class="n">ax_map</span><span class="o">.</span><span class="n">set_extent</span><span class="p">(</span><span class="n">extent</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">projection</span><span class="p">)</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">,</span><span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>

<span class="c1"># Run the fake through the assimilator and produce an iris cube</span>
<span class="n">pm</span> <span class="o">=</span> <span class="n">ic</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">result</span><span class="o">=</span><span class="n">autoencoder</span><span class="o">.</span><span class="n">predict_on_batch</span><span class="p">(</span><span class="n">obs_t</span><span class="p">)</span>
<span class="n">result</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">result</span><span class="p">,[</span><span class="mi">91</span><span class="p">,</span><span class="mi">180</span><span class="p">])</span>
<span class="n">pm</span><span class="o">.</span><span class="n">data</span><span class="o">=</span><span class="n">unnormalise</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="c1"># Background, grid and land</span>
<span class="n">ax_map</span><span class="o">.</span><span class="n">background_patch</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">((</span><span class="mf">0.88</span><span class="p">,</span><span class="mf">0.88</span><span class="p">,</span><span class="mf">0.88</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="c1">#mg.background.add_grid(ax_map)</span>
<span class="n">land_img_orig</span><span class="o">=</span><span class="n">ax_map</span><span class="o">.</span><span class="n">background_img</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;GreyT&#39;</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="s1">&#39;low&#39;</span><span class="p">)</span>

<span class="c1"># Station locations</span>
<span class="n">mg</span><span class="o">.</span><span class="n">observations</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax_map</span><span class="p">,</span><span class="n">obs</span><span class="p">,</span><span class="n">radius</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                     <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
                     <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
                     <span class="n">linewidths</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="c1"># original pressures as red contours</span>
<span class="n">mg</span><span class="o">.</span><span class="n">pressure</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax_map</span><span class="p">,</span><span class="n">ic</span><span class="p">,</span>
                 <span class="n">scale</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                 <span class="n">resolution</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>
                 <span class="n">levels</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">870</span><span class="p">,</span><span class="mi">1050</span><span class="p">,</span><span class="mi">7</span><span class="p">),</span>
                 <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span>
                 <span class="n">label</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">linewidths</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="c1"># Encoded pressures as blue contours</span>
<span class="n">mg</span><span class="o">.</span><span class="n">pressure</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax_map</span><span class="p">,</span><span class="n">pm</span><span class="p">,</span>
                 <span class="n">scale</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                 <span class="n">resolution</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>
                 <span class="n">levels</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">870</span><span class="p">,</span><span class="mi">1050</span><span class="p">,</span><span class="mi">7</span><span class="p">),</span>
                 <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span>
                 <span class="n">label</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">linewidths</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">mg</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">plot_label</span><span class="p">(</span><span class="n">ax_map</span><span class="p">,</span>
                    <span class="s1">&#39;</span><span class="si">%04d</span><span class="s1">-</span><span class="si">%02d</span><span class="s1">-</span><span class="si">%02d</span><span class="s1">:</span><span class="si">%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">year</span><span class="p">,</span><span class="n">month</span><span class="p">,</span><span class="n">day</span><span class="p">,</span><span class="n">hour</span><span class="p">),</span>
                    <span class="n">facecolor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.88</span><span class="p">,</span><span class="mf">0.88</span><span class="p">,</span><span class="mf">0.88</span><span class="p">,</span><span class="mf">0.9</span><span class="p">),</span>
                    <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                    <span class="n">x_fraction</span><span class="o">=</span><span class="mf">0.98</span><span class="p">,</span>
                    <span class="n">y_fraction</span><span class="o">=</span><span class="mf">0.03</span><span class="p">,</span>
                    <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span>
                    <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>

<span class="c1"># Scatterplot of encoded v original</span>
<span class="n">ax</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.08</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.45</span><span class="p">,</span><span class="mf">0.4</span><span class="p">])</span>
<span class="n">aspect</span><span class="o">=.</span><span class="mi">225</span><span class="o">/.</span><span class="mi">4</span><span class="o">*</span><span class="mi">16</span><span class="o">/</span><span class="mi">9</span>
<span class="c1"># Axes ranges from data</span>
<span class="n">dmin</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">ic</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">pm</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
<span class="n">dmax</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">ic</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span><span class="n">pm</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<span class="n">dmean</span><span class="o">=</span><span class="p">(</span><span class="n">dmin</span><span class="o">+</span><span class="n">dmax</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
<span class="n">dmax</span><span class="o">=</span><span class="n">dmean</span><span class="o">+</span><span class="p">(</span><span class="n">dmax</span><span class="o">-</span><span class="n">dmean</span><span class="p">)</span><span class="o">*</span><span class="mf">1.05</span>
<span class="n">dmin</span><span class="o">=</span><span class="n">dmean</span><span class="o">-</span><span class="p">(</span><span class="n">dmean</span><span class="o">-</span><span class="n">dmin</span><span class="p">)</span><span class="o">*</span><span class="mf">1.05</span>
<span class="k">if</span> <span class="n">aspect</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">dmin</span><span class="o">/</span><span class="mi">100</span><span class="p">,</span><span class="n">dmax</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="n">dmean</span><span class="o">-</span><span class="p">(</span><span class="n">dmean</span><span class="o">-</span><span class="n">dmin</span><span class="p">)</span><span class="o">*</span><span class="n">aspect</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">,</span>
                <span class="p">(</span><span class="n">dmean</span><span class="o">+</span><span class="p">(</span><span class="n">dmax</span><span class="o">-</span><span class="n">dmean</span><span class="p">)</span><span class="o">*</span><span class="n">aspect</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">dmin</span><span class="o">/</span><span class="mi">100</span><span class="p">,</span><span class="n">dmax</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="n">dmean</span><span class="o">-</span><span class="p">(</span><span class="n">dmean</span><span class="o">-</span><span class="n">dmin</span><span class="p">)</span><span class="o">*</span><span class="n">aspect</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">,</span>
                <span class="p">(</span><span class="n">dmean</span><span class="o">+</span><span class="p">(</span><span class="n">dmax</span><span class="o">-</span><span class="n">dmean</span><span class="p">)</span><span class="o">*</span><span class="n">aspect</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">pm</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">/</span><span class="mi">100</span><span class="p">,</span>
           <span class="n">y</span><span class="o">=</span><span class="n">ic</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">/</span><span class="mi">100</span><span class="p">,</span>
           <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
           <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
           <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span>
           <span class="n">s</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;20CR2c&#39;</span><span class="p">,</span> 
       <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Constructed&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
        <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> 
        <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>


<span class="c1"># Plot the training history</span>
<span class="n">history_save_file</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/Machine-Learning-experiments/&quot;</span><span class="o">+</span>
              <span class="s2">&quot;oldstyle_assimilation_1916/&quot;</span><span class="o">+</span>
              <span class="s2">&quot;saved_models/history_to_</span><span class="si">%04d</span><span class="s2">.pkl&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span>
                 <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;SCRATCH&#39;</span><span class="p">),</span><span class="mi">50</span><span class="p">)</span>
<span class="n">history</span><span class="o">=</span><span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span> <span class="nb">open</span><span class="p">(</span> <span class="n">history_save_file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span> <span class="p">)</span> <span class="p">)</span>
<span class="n">ax</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.62</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.35</span><span class="p">,</span><span class="mf">0.4</span><span class="p">])</span>
<span class="c1"># Axes ranges from data</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">],</span>
                                           <span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">]))))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Epochs&#39;</span><span class="p">,</span> 
       <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Loss (grey) and validation loss (black)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
        <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> 
        <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">])),</span>
        <span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">],</span>
        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span>
        <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">])),</span>
        <span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">],</span>
        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
        <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>


<span class="c1"># Render the figure as a png</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;comparison_results.png&quot;</span><span class="p">)</span>

</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="archive_to_Tensor.html" title="Making Tensors of pseudo-observations"
             >next</a> |</li>
        <li class="right" >
          <a href="../convolutional_perturbations/latent_space/autoencoder.html" title="An all-convolutional autoencoder with an explicit latent space"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">ML Experiments</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    </div>
  </body>
</html>