
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Regularizing the simple autoencoder &#8212; Machine Learning Experiments</title>
    <link rel="stylesheet" href="../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Regularized autoencoder validation script" href="validation.html" />
    <link rel="prev" title="Perturbed autoencoder validation script" href="../more_neurons_64/validation.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="validation.html" title="Regularized autoencoder validation script"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../more_neurons_64/validation.html" title="Perturbed autoencoder validation script"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">ML Experiments</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../perturbations.html" accesskey="U">Perturbing the simple autoencoder</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/Weather-Network.png" alt="Logo"/>
            </a></p>
<h3><a href="../../index.html">Table of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../prepare_data/prepare_data.html">Getting climate data into TensorFlow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../simple_autoencoder/autoencoder.html">Getting started - a simple autoencoder</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../perturbations.html">Perturbing the simple autoencoder</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../package/ML_Utilities.html">ML Utilities package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../credits.html">Small Print</a></li>
</ul>
<h3><a href="https://github.com/philip-brohan/Machine-Learning">Get the source code</a></h3>

<a href="https://github.com/philip-brohan/Machine-Learning"
           rel="nofollow">Github source repository</a>

<h3>Found a bug, or have a suggestion?</h3>

Please <a href="https://github.com/philip-brohan/Machine-Learning/issues/new">raise an issue</a>.
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="regularizing-the-simple-autoencoder">
<h1>Regularizing the simple autoencoder<a class="headerlink" href="#regularizing-the-simple-autoencoder" title="Permalink to this headline">¶</a></h1>
<p>The <a class="reference internal" href="../../simple_autoencoder/autoencoder.html"><span class="doc">simple autoencoder</span></a> has 32 neurons in its hidden layer. If this were a linear regression problem with 32 features, I’d worry about overfitting because of colinearity between the features in the training set, and apparently similar things can happen in neural network models. The traditional defence against such overfitting is <a class="reference external" href="https://en.wikipedia.org/wiki/Regularization_(mathematics)">regularization</a>, and (again following <a class="reference external" href="https://www.kaggle.com/vikramtiwari/autoencoders-using-tf-keras-mnist">Vikram Tiwari</a>) we can add a <a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/keras/regularizers">tf.keras.regularizers</a> entry to our hidden layer to reduce possible overfitting here.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="c1"># Very simple autoencoder for 20CR prmsl fields.</span>
<span class="c1"># Single, fully-connected layer as encoder+decoder, 32 neurons.</span>
<span class="c1"># Very unlikely to work well at all, but this isn&#39;t about good</span>
<span class="c1">#  results, it&#39;s about getting started. </span>

<span class="c1"># This version adds regularisation to help against overfitting.</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">ML_Utilities</span>

<span class="c1"># How many epochs to train for</span>
<span class="n">n_epochs</span><span class="o">=</span><span class="mi">100</span>

<span class="c1"># Create TensorFlow Dataset object from the prepared training data</span>
<span class="p">(</span><span class="n">tr_data</span><span class="p">,</span><span class="n">n_steps</span><span class="p">)</span> <span class="o">=</span> <span class="n">ML_Utilities</span><span class="o">.</span><span class="n">dataset</span><span class="p">(</span><span class="n">purpose</span><span class="o">=</span><span class="s1">&#39;training&#39;</span><span class="p">,</span>
                                         <span class="n">source</span><span class="o">=</span><span class="s1">&#39;20CR2c&#39;</span><span class="p">,</span>
                                         <span class="n">variable</span><span class="o">=</span><span class="s1">&#39;prmsl&#39;</span><span class="p">)</span>
<span class="n">tr_data</span> <span class="o">=</span> <span class="n">tr_data</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">n_epochs</span><span class="p">)</span>

<span class="c1"># Need to reshape the data to linear, and produce a tuple</span>
<span class="c1">#  (source,target) for model</span>
<span class="k">def</span> <span class="nf">to_model</span><span class="p">(</span><span class="n">ict</span><span class="p">):</span>
   <span class="n">ict</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ict</span><span class="p">,[</span><span class="mi">1</span><span class="p">,</span><span class="mi">91</span><span class="o">*</span><span class="mi">180</span><span class="p">])</span>
   <span class="k">return</span><span class="p">(</span><span class="n">ict</span><span class="p">,</span><span class="n">ict</span><span class="p">)</span>
<span class="n">tr_data</span> <span class="o">=</span> <span class="n">tr_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">to_model</span><span class="p">)</span>

<span class="c1"># Similar dataset from the prepared test data</span>
<span class="p">(</span><span class="n">tr_test</span><span class="p">,</span><span class="n">test_steps</span><span class="p">)</span> <span class="o">=</span> <span class="n">ML_Utilities</span><span class="o">.</span><span class="n">dataset</span><span class="p">(</span><span class="n">purpose</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span>
                                            <span class="n">source</span><span class="o">=</span><span class="s1">&#39;20CR2c&#39;</span><span class="p">,</span>
                                            <span class="n">variable</span><span class="o">=</span><span class="s1">&#39;prmsl&#39;</span><span class="p">)</span>
<span class="n">tr_test</span> <span class="o">=</span> <span class="n">tr_test</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">n_epochs</span><span class="p">)</span>
<span class="n">tr_test</span> <span class="o">=</span> <span class="n">tr_test</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">to_model</span><span class="p">)</span>

<span class="c1"># Input placeholder - treat data as 1d</span>
<span class="n">original</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">91</span><span class="o">*</span><span class="mi">180</span><span class="p">,))</span>
<span class="c1"># Encoding layer 32-neuron fully-connected - with regularizer.</span>
<span class="n">encoded</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">,</span>
               <span class="n">activity_regularizer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">regularizers</span><span class="o">.</span><span class="n">l1</span><span class="p">(</span><span class="mf">10e-5</span><span class="p">))(</span><span class="n">original</span><span class="p">)</span>
<span class="c1"># Output layer - same shape as input</span>
<span class="n">decoded</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">91</span><span class="o">*</span><span class="mi">180</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">)(</span><span class="n">encoded</span><span class="p">)</span>

<span class="c1"># Model relating original to output</span>
<span class="n">autoencoder</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">decoded</span><span class="p">)</span>
<span class="c1"># Choose a loss metric to minimise (RMS)</span>
<span class="c1">#  and an optimiser to use (adadelta)</span>
<span class="n">autoencoder</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;adadelta&#39;</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mean_squared_error&#39;</span><span class="p">)</span>

<span class="c1"># Train the autoencoder</span>
<span class="n">autoencoder</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">tr_data</span><span class="p">,</span> <span class="c1"># Get (source,target) pairs from this Dataset</span>
                <span class="n">epochs</span><span class="o">=</span><span class="n">n_epochs</span><span class="p">,</span>
                <span class="n">steps_per_epoch</span><span class="o">=</span><span class="n">n_steps</span><span class="p">,</span>
                <span class="n">validation_data</span><span class="o">=</span><span class="n">tr_test</span><span class="p">,</span>
                <span class="n">validation_steps</span><span class="o">=</span><span class="n">test_steps</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># One line per epoch</span>

<span class="c1"># Save the model</span>
<span class="n">save_file</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/Machine-Learning-experiments/&quot;</span><span class="o">+</span>
           <span class="s2">&quot;simple_autoencoder_perturbations/regularized/&quot;</span><span class="o">+</span>
           <span class="s2">&quot;saved_models/Epoch_</span><span class="si">%04d</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span>
                 <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;SCRATCH&#39;</span><span class="p">),</span><span class="n">n_epochs</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">save_file</span><span class="p">)):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">save_file</span><span class="p">))</span>
<span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">autoencoder</span><span class="p">,</span><span class="n">save_file</span><span class="p">)</span>
</pre></div>
</div>
<p>We already know, however, that this model is not overfitting badly, because we have both a training and a test dataset, and the loss metrics are about the same. If the model were overfitting, the validation loss would be much bigger than the training loss. Regularisation should slightly degrade the model fit to the training data, and it does (training loss metric at 100 epochs goes from 0.1953 to 0.1985), and it might help the fit to the validation data if the validation loss were notably worse than the training loss, but here it isn’t, so regularisation has little effect (validation loss metric at 100 epochs goes from 0.1910 to 0.1942):</p>
<div class="figure align-center" id="id1" style="width: 95%">
<a class="reference internal image-reference" href="../../_images/comparison_2009-03-12:066.png"><img alt="../../_images/comparison_2009-03-12:066.png" src="../../_images/comparison_2009-03-12:066.png" style="width: 95%;" /></a>
<p class="caption"><span class="caption-text">MSLP contours from 20CR2c for 2009-03-12:06. Original in top panel - after passing through the original simple autoencoder in middle panel, and after passing through the regularized autoencoder in bottom panel. Note that the contour spacings are different between the panels.</span></p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="validation.html">Regularized autoencoder validation script</a></li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="validation.html" title="Regularized autoencoder validation script"
             >next</a> |</li>
        <li class="right" >
          <a href="../more_neurons_64/validation.html" title="Perturbed autoencoder validation script"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">ML Experiments</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../perturbations.html" >Perturbing the simple autoencoder</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    </div>
  </body>
</html>