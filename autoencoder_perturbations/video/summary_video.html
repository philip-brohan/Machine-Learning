
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Video diagnostics of model training &#8212; Machine Learning Experiments</title>
    <link rel="stylesheet" href="../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Video diagnostics of model output" href="comparison_video.html" />
    <link rel="prev" title="Generating video diagnostics" href="video.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="comparison_video.html" title="Video diagnostics of model output"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="video.html" title="Generating video diagnostics"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">ML Experiments</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../perturbations.html" >Perturbing the simple autoencoder</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="video.html" accesskey="U">Generating video diagnostics</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/Weather-Network.png" alt="Logo"/>
            </a></p>
<h3><a href="../../index.html">Table of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../prepare_data/prepare_data.html">Getting climate data into TensorFlow</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../simple_autoencoder/autoencoder.html">Getting started - a simple autoencoder</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../perturbations.html">Perturbing the simple autoencoder</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deep_autoencoder/autoencoder.html">A deep autoencoder</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../convolutional_autoencoder/autoencoder.html">A convolutional autoencoder</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../convolutional_perturbations/perturbations.html">Perturbing the convolutional autoencoder</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../oldstyle_assimilation/assimilation.html">Old-style assimilation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../oldstyle_assimilation/prate/assimilation.html">Old-style assimilation of precipitation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../package/ML_Utilities.html">ML Utilities package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../credits.html">Small Print</a></li>
</ul>
<h3><a href="https://github.com/philip-brohan/Machine-Learning">Get the source code</a></h3>

<a href="https://github.com/philip-brohan/Machine-Learning"
           rel="nofollow">Github source repository</a>

<h3>Found a bug, or have a suggestion?</h3>

Please <a href="https://github.com/philip-brohan/Machine-Learning/issues/new">raise an issue</a>.
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="video-diagnostics-of-model-training">
<h1>Video diagnostics of model training<a class="headerlink" href="#video-diagnostics-of-model-training" title="Permalink to this headline">Â¶</a></h1>
<center>
<table><tr><td><center>
<iframe src="https://player.vimeo.com/video/338277430?title=0&byline=0&portrait=0" width="795" height="448" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe></center></td></tr>
<tr><td><center>Autencoder model state (left) validation (right)</center></td></tr>
</table>
</center><p>On the left, the model weights: The boxplot in the centre shows the weights associated with each neuron in the hidden layer, arranged in order, largest to smallest. Negative weights have been converted to positive (and the sign of the associated output layer weights switched accordingly). The colourmaps on top are the weights, for each hidden layer neuron, for each input field location (so a lat:lon map). They are aranged in the same order as the hidden layer weights (so if hidden-layer neuron 3 has the largest weight, the input layer weights for neuron 3 are shown at top left). The colourmaps on the bottom are the output layer weights, arranged in the same way.</p>
<p>Top right, a sample pressure field: Original in red, after passing through the autoencoder in blue.</p>
<p>Bottom right, training progress: Loss v. no. of training epochs (but note that one epoch here is different (fewer training fields) than one epoch in the other examples).</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>That means saving the model state after each epoch, and having more, shorter epochs - we can modify the autoencoder script to do this.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="c1"># Very simple autoencoder for 20CR prmsl fields.</span>
<span class="c1"># Single, fully-connected layer as encoder+decoder, 32 neurons.</span>
<span class="c1"># Very unlikely to work well at all, but this isn&#39;t about good</span>
<span class="c1">#  results, it&#39;s about getting started. </span>
<span class="c1">#</span>
<span class="c1"># This version concentrates on tracking the training of the autoencoder</span>
<span class="c1">#  so small batches/epochs and save the state at every point.</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="c1">#tf.enable_eager_execution()</span>
<span class="kn">from</span> <span class="nn">tensorflow.data</span> <span class="k">import</span> <span class="n">Dataset</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="k">import</span> <span class="n">glob</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="c1"># How much to do between output points</span>
<span class="n">epoch_size</span><span class="o">=</span><span class="mi">100</span>
<span class="c1"># How much training in total</span>
<span class="n">n_epochs</span><span class="o">=</span><span class="mi">1000</span>

<span class="c1"># File names for the serialised tensors to train on</span>
<span class="n">input_file_dir</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/Machine-Learning-experiments/datasets/20CR2c/prmsl/training/&quot;</span> <span class="o">%</span>
                   <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;SCRATCH&#39;</span><span class="p">))</span>
<span class="n">training_files</span><span class="o">=</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/*.tfd&quot;</span> <span class="o">%</span> <span class="n">input_file_dir</span><span class="p">)</span>
<span class="n">n_tf</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">training_files</span><span class="p">)</span>
<span class="n">train_tfd</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">training_files</span><span class="p">)</span>

<span class="c1"># Create TensorFlow Dataset object from the file names</span>
<span class="n">tr_data</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensor_slices</span><span class="p">(</span><span class="n">train_tfd</span><span class="p">)</span>

<span class="c1"># Repeat the input data enough times that we don&#39;t run out </span>
<span class="n">n_reps</span><span class="o">=</span><span class="p">(</span><span class="n">epoch_size</span><span class="o">*</span><span class="n">n_epochs</span><span class="p">)</span><span class="o">//</span><span class="n">n_tf</span> <span class="o">+</span><span class="mi">1</span>
<span class="n">tr_data</span> <span class="o">=</span> <span class="n">tr_data</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">n_reps</span><span class="p">)</span>

<span class="c1"># We don&#39;t want the file names, we want their contents, so</span>
<span class="c1">#  add a map to convert from names to contents.</span>
<span class="k">def</span> <span class="nf">load_tensor</span><span class="p">(</span><span class="n">file_name</span><span class="p">):</span>
    <span class="n">sict</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span> <span class="c1"># serialised</span>
    <span class="n">ict</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">parse_tensor</span><span class="p">(</span><span class="n">sict</span><span class="p">,</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ict</span>
<span class="n">tr_data</span> <span class="o">=</span> <span class="n">tr_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">load_tensor</span><span class="p">)</span>

<span class="c1"># Also need to reshape the data to linear, and produce a tuple</span>
<span class="c1">#  (source,target) for model</span>
<span class="k">def</span> <span class="nf">to_model</span><span class="p">(</span><span class="n">ict</span><span class="p">):</span>
   <span class="n">ict</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ict</span><span class="p">,[</span><span class="mi">1</span><span class="p">,</span><span class="mi">91</span><span class="o">*</span><span class="mi">180</span><span class="p">])</span>
   <span class="k">return</span><span class="p">(</span><span class="n">ict</span><span class="p">,</span><span class="n">ict</span><span class="p">)</span>
<span class="n">tr_data</span> <span class="o">=</span> <span class="n">tr_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">to_model</span><span class="p">)</span>

<span class="c1"># Input placeholder - treat data as 1d</span>
<span class="n">original</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">91</span><span class="o">*</span><span class="mi">180</span><span class="p">,))</span>
<span class="c1"># Encoding layer 32-neuron fully-connected</span>
<span class="n">encoded</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">)(</span><span class="n">original</span><span class="p">)</span>
<span class="c1"># Output layer - same shape as input</span>
<span class="n">decoded</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">91</span><span class="o">*</span><span class="mi">180</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">)(</span><span class="n">encoded</span><span class="p">)</span>

<span class="c1"># Model relating original to output</span>
<span class="n">autoencoder</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">decoded</span><span class="p">)</span>
<span class="c1"># Choose a loss metric to minimise (RMS)</span>
<span class="c1">#  and an optimiser to use (adadelta)</span>
<span class="n">autoencoder</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;adadelta&#39;</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mean_squared_error&#39;</span><span class="p">)</span>

<span class="c1"># Set up a callback to save the model state</span>
<span class="n">checkpoint</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/Machine-Learning-experiments/&quot;</span><span class="o">+</span>
                <span class="s2">&quot;simple_autoencoder_instrumented/&quot;</span><span class="o">+</span>
                <span class="s2">&quot;saved_models/Epoch_</span><span class="si">{epoch:04d}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;SCRATCH&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">)):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">))</span>
<span class="n">cp_callback</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">ModelCheckpoint</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">,</span> 
                                                 <span class="n">save_weights_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                 <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Train the autoencoder - saving it every epoch</span>
<span class="n">history</span><span class="o">=</span><span class="n">autoencoder</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">tr_data</span><span class="p">,</span> <span class="c1"># Get (source,target) pairs from this Dataset</span>
                        <span class="n">epochs</span><span class="o">=</span><span class="n">n_epochs</span><span class="p">,</span>
                        <span class="n">steps_per_epoch</span><span class="o">=</span><span class="n">epoch_size</span><span class="p">,</span>
                        <span class="n">callbacks</span> <span class="o">=</span> <span class="p">[</span><span class="n">cp_callback</span><span class="p">],</span>
                        <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># One line per epoch</span>

<span class="c1"># Save the training history</span>
<span class="n">history_file</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/Machine-Learning-experiments/&quot;</span><span class="o">+</span>
              <span class="s2">&quot;simple_autoencoder_instrumented/&quot;</span><span class="o">+</span>
              <span class="s2">&quot;saved_models/history_to_</span><span class="si">%04d</span><span class="s2">.pkl&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span>
                 <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;SCRATCH&#39;</span><span class="p">),</span><span class="n">n_epochs</span><span class="p">)</span>
<span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">history_file</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>Then we need a script to make a <a class="reference internal" href="../../simple_autoencoder/summary.html"><span class="doc">summary plot</span></a> at each epoch:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="c1"># General model quality plot</span>
<span class="c1"># Can be run at any epoch - for video diagnoistics.</span>

<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="n">tf</span><span class="o">.</span><span class="n">enable_eager_execution</span><span class="p">()</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="kn">import</span> <span class="nn">IRData.twcr</span> <span class="k">as</span> <span class="nn">twcr</span>
<span class="kn">import</span> <span class="nn">iris</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="kn">import</span> <span class="nn">Meteorographica</span> <span class="k">as</span> <span class="nn">mg</span>

<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">from</span> <span class="nn">matplotlib.backends.backend_agg</span> <span class="k">import</span> <span class="n">FigureCanvasAgg</span> <span class="k">as</span> <span class="n">FigureCanvas</span>
<span class="kn">from</span> <span class="nn">matplotlib.figure</span> <span class="k">import</span> <span class="n">Figure</span>
<span class="kn">import</span> <span class="nn">cartopy</span>
<span class="kn">import</span> <span class="nn">cartopy.crs</span> <span class="k">as</span> <span class="nn">ccrs</span>

<span class="kn">import</span> <span class="nn">argparse</span>
<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--epoch&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Model at which epoch?&quot;</span><span class="p">,</span>
                    <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

<span class="c1"># Get the 20CR data</span>
<span class="n">ic</span><span class="o">=</span><span class="n">twcr</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;prmsl&#39;</span><span class="p">,</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2009</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span>
                           <span class="n">version</span><span class="o">=</span><span class="s1">&#39;2c&#39;</span><span class="p">)</span>
<span class="n">ic</span><span class="o">=</span><span class="n">ic</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">iris</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">member</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

<span class="c1"># Get the autoencoder at 1000 epochs</span>
<span class="n">model_save_file</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/Machine-Learning-experiments/&quot;</span><span class="o">+</span>
                   <span class="s2">&quot;simple_autoencoder_instrumented/&quot;</span><span class="o">+</span>
                   <span class="s2">&quot;saved_models/Epoch_</span><span class="si">%04d</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span>
                         <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;SCRATCH&#39;</span><span class="p">),</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">autoencoder</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">model_save_file</span><span class="p">)</span>
<span class="c1"># Get the order of the hidden weights - most to least important</span>
<span class="n">order</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">autoencoder</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()[</span><span class="mi">1</span><span class="p">]))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="c1"># Get the largest converged hidden weight</span>
<span class="n">hw_max</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">autoencoder</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()[</span><span class="mi">1</span><span class="p">]))</span>

<span class="c1"># Get the autoencoder at the chosen epoch</span>
<span class="n">model_save_file</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/Machine-Learning-experiments/&quot;</span><span class="o">+</span>
                   <span class="s2">&quot;simple_autoencoder_instrumented/&quot;</span><span class="o">+</span>
                   <span class="s2">&quot;saved_models/Epoch_</span><span class="si">%04d</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span>
                         <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;SCRATCH&#39;</span><span class="p">),</span><span class="n">args</span><span class="o">.</span><span class="n">epoch</span><span class="p">)</span>
<span class="n">autoencoder</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">model_save_file</span><span class="p">)</span>

<span class="c1"># Normalisation - Pa to mean=0, sd=1 - and back</span>
<span class="k">def</span> <span class="nf">normalise</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
   <span class="n">x</span> <span class="o">-=</span> <span class="mi">101325</span>
   <span class="n">x</span> <span class="o">/=</span> <span class="mi">3000</span>
   <span class="k">return</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">unnormalise</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
   <span class="n">x</span> <span class="o">*=</span> <span class="mi">3000</span>
   <span class="n">x</span> <span class="o">+=</span> <span class="mi">101325</span>
   <span class="k">return</span> <span class="n">x</span>

<span class="n">fig</span><span class="o">=</span><span class="n">Figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">19.2</span><span class="p">,</span><span class="mf">10.8</span><span class="p">),</span>  <span class="c1"># 1920x1080, HD</span>
           <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
           <span class="n">facecolor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.88</span><span class="p">,</span><span class="mf">0.88</span><span class="p">,</span><span class="mf">0.88</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
           <span class="n">edgecolor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
           <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
           <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
           <span class="n">subplotpars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
           <span class="n">tight_layout</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">canvas</span><span class="o">=</span><span class="n">FigureCanvas</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

<span class="c1"># Top right - map showing original and reconstructed fields</span>
<span class="n">projection</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">RotatedPole</span><span class="p">(</span><span class="n">pole_longitude</span><span class="o">=</span><span class="mf">180.0</span><span class="p">,</span> <span class="n">pole_latitude</span><span class="o">=</span><span class="mf">90.0</span><span class="p">)</span>
<span class="n">ax_map</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.505</span><span class="p">,</span><span class="mf">0.51</span><span class="p">,</span><span class="mf">0.475</span><span class="p">,</span><span class="mf">0.47</span><span class="p">],</span><span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">)</span>
<span class="n">ax_map</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
<span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span><span class="mi">180</span><span class="p">,</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span><span class="mi">90</span><span class="p">]</span>
<span class="n">ax_map</span><span class="o">.</span><span class="n">set_extent</span><span class="p">(</span><span class="n">extent</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">projection</span><span class="p">)</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">,</span><span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>

<span class="c1"># Run the data through the autoencoder and convert back to iris cube</span>
<span class="n">pm</span><span class="o">=</span><span class="n">ic</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">pm</span><span class="o">.</span><span class="n">data</span><span class="o">=</span><span class="n">normalise</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
<span class="n">ict</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">convert_to_tensor</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">ict</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ict</span><span class="p">,[</span><span class="mi">1</span><span class="p">,</span><span class="mi">91</span><span class="o">*</span><span class="mi">180</span><span class="p">])</span> <span class="c1"># ????</span>
<span class="n">result</span><span class="o">=</span><span class="n">autoencoder</span><span class="o">.</span><span class="n">predict_on_batch</span><span class="p">(</span><span class="n">ict</span><span class="p">)</span>
<span class="n">result</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">result</span><span class="p">,[</span><span class="mi">91</span><span class="p">,</span><span class="mi">180</span><span class="p">])</span>
<span class="n">pm</span><span class="o">.</span><span class="n">data</span><span class="o">=</span><span class="n">unnormalise</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="c1"># Background, grid and land</span>
<span class="n">ax_map</span><span class="o">.</span><span class="n">background_patch</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">((</span><span class="mf">0.88</span><span class="p">,</span><span class="mf">0.88</span><span class="p">,</span><span class="mf">0.88</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="c1">#mg.background.add_grid(ax_map)</span>
<span class="n">land_img_orig</span><span class="o">=</span><span class="n">ax_map</span><span class="o">.</span><span class="n">background_img</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;GreyT&#39;</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="s1">&#39;low&#39;</span><span class="p">)</span>

<span class="c1"># original pressures as red contours</span>
<span class="n">mg</span><span class="o">.</span><span class="n">pressure</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax_map</span><span class="p">,</span><span class="n">ic</span><span class="p">,</span>
                 <span class="n">scale</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                 <span class="n">resolution</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>
                 <span class="n">levels</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">870</span><span class="p">,</span><span class="mi">1050</span><span class="p">,</span><span class="mi">7</span><span class="p">),</span>
                 <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span>
                 <span class="n">label</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">linewidths</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="c1"># Encoded pressures as blue contours</span>
<span class="n">mg</span><span class="o">.</span><span class="n">pressure</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax_map</span><span class="p">,</span><span class="n">pm</span><span class="p">,</span>
                 <span class="n">scale</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                 <span class="n">resolution</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>
                 <span class="n">levels</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">870</span><span class="p">,</span><span class="mi">1050</span><span class="p">,</span><span class="mi">7</span><span class="p">),</span>
                 <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span>
                 <span class="n">label</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">linewidths</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">mg</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">plot_label</span><span class="p">(</span><span class="n">ax_map</span><span class="p">,</span>
                    <span class="s1">&#39;</span><span class="si">%04d</span><span class="s1">-</span><span class="si">%02d</span><span class="s1">-</span><span class="si">%02d</span><span class="s1">:</span><span class="si">%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2009</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span>
                    <span class="n">facecolor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.88</span><span class="p">,</span><span class="mf">0.88</span><span class="p">,</span><span class="mf">0.88</span><span class="p">,</span><span class="mf">0.9</span><span class="p">),</span>
                    <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                    <span class="n">x_fraction</span><span class="o">=</span><span class="mf">0.98</span><span class="p">,</span>
                    <span class="n">y_fraction</span><span class="o">=</span><span class="mf">0.03</span><span class="p">,</span>
                    <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span>
                    <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>

<span class="c1"># Add the model weights on the left</span>
<span class="c1"># Where on the plot to put each axes</span>
<span class="k">def</span> <span class="nf">axes_geom</span><span class="p">(</span><span class="n">layer</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">channel</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">nchannels</span><span class="o">=</span><span class="mi">36</span><span class="p">):</span>
     <span class="k">if</span> <span class="n">layer</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> 
         <span class="n">base</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.6</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.4</span><span class="p">]</span>
     <span class="k">else</span><span class="p">:</span>
         <span class="n">base</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.4</span><span class="p">]</span>
     <span class="n">ncol</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">nchannels</span><span class="p">)</span>
     <span class="n">nr</span><span class="o">=</span><span class="n">channel</span><span class="o">//</span><span class="n">ncol</span>
     <span class="n">nc</span><span class="o">=</span><span class="n">channel</span><span class="o">-</span><span class="n">ncol</span><span class="o">*</span><span class="n">nr</span>
     <span class="n">nr</span><span class="o">=</span><span class="n">ncol</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">nr</span> <span class="c1"># Top down</span>
     <span class="n">geom</span><span class="o">=</span><span class="p">[</span><span class="n">base</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">base</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">ncol</span><span class="p">)</span><span class="o">*</span><span class="mf">0.95</span><span class="o">*</span><span class="n">nc</span><span class="p">,</span>
           <span class="n">base</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">base</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="n">ncol</span><span class="p">)</span><span class="o">*</span><span class="mf">0.95</span><span class="o">*</span><span class="n">nr</span><span class="p">,</span>
           <span class="p">(</span><span class="n">base</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">ncol</span><span class="p">)</span><span class="o">*</span><span class="mf">0.95</span><span class="p">,</span>
           <span class="p">(</span><span class="n">base</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="n">ncol</span><span class="p">)</span><span class="o">*</span><span class="mf">0.95</span><span class="p">]</span>
     <span class="n">geom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="mf">0.05</span><span class="o">*</span><span class="n">base</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">ncol</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">nc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
     <span class="n">geom</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="mf">0.05</span><span class="o">*</span><span class="n">base</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">ncol</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">nr</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
     <span class="k">return</span> <span class="n">geom</span>

<span class="c1"># Plot a single set of weights</span>
<span class="k">def</span> <span class="nf">plot_weights</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span><span class="n">layer</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">channel</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">nchannels</span><span class="o">=</span><span class="mi">36</span><span class="p">,</span>
                 <span class="n">vmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">ax_input</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">(</span><span class="n">axes_geom</span><span class="p">(</span><span class="n">layer</span><span class="o">=</span><span class="n">layer</span><span class="p">,</span>
                                    <span class="n">channel</span><span class="o">=</span><span class="n">channel</span><span class="p">,</span>
                                    <span class="n">nchannels</span><span class="o">=</span><span class="n">nchannels</span><span class="p">),</span>
                          <span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">)</span>
    <span class="n">ax_input</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
    <span class="n">ax_input</span><span class="o">.</span><span class="n">set_extent</span><span class="p">(</span><span class="n">extent</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">projection</span><span class="p">)</span>
    <span class="n">ax_input</span><span class="o">.</span><span class="n">background_patch</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">((</span><span class="mf">0.88</span><span class="p">,</span><span class="mf">0.88</span><span class="p">,</span><span class="mf">0.88</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>

    <span class="n">lats</span> <span class="o">=</span> <span class="n">w_in</span><span class="o">.</span><span class="n">coord</span><span class="p">(</span><span class="s1">&#39;latitude&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">points</span>
    <span class="n">lons</span> <span class="o">=</span> <span class="n">w_in</span><span class="o">.</span><span class="n">coord</span><span class="p">(</span><span class="s1">&#39;longitude&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">points</span><span class="o">-</span><span class="mi">180</span>
    <span class="n">prate_img</span><span class="o">=</span><span class="n">ax_input</span><span class="o">.</span><span class="n">pcolorfast</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">w_in</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> 
                            <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">,</span>
                            <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span>
                            <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
                            <span class="p">)</span>

<span class="c1"># Plot the hidden layer weights</span>
<span class="k">def</span> <span class="nf">plot_hidden</span><span class="p">(</span><span class="n">weights</span><span class="p">):</span>
     <span class="c1"># Single axes - var v. time</span>
     <span class="n">ax</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.425</span><span class="p">,</span><span class="mf">0.425</span><span class="p">,</span><span class="mf">0.15</span><span class="p">])</span>
     <span class="c1"># Axes ranges from data</span>
     <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.6</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="o">-</span><span class="mf">0.4</span><span class="p">)</span>
     <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">hw_max</span><span class="o">*</span><span class="mf">1.05</span><span class="p">)</span>
     <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)),</span>
            <span class="n">height</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="n">order</span><span class="p">]),</span>
            <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span>
            <span class="n">tick_label</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>

<span class="n">plot_hidden</span><span class="p">(</span><span class="n">autoencoder</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
<span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]:</span>
    <span class="n">w_l</span><span class="o">=</span><span class="n">autoencoder</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()[</span><span class="n">layer</span><span class="p">]</span>
    <span class="n">vmin</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">w_l</span><span class="p">)</span><span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">w_l</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span>
    <span class="n">vmax</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">w_l</span><span class="p">)</span><span class="o">+</span><span class="n">numpy</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">w_l</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span>
    <span class="n">count</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">order</span><span class="p">:</span>
        <span class="n">w_in</span><span class="o">=</span><span class="n">ic</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">layer</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">w_in</span><span class="o">.</span><span class="n">data</span><span class="o">=</span><span class="n">w_l</span><span class="p">[:,</span><span class="n">channel</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ic</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">w_in</span><span class="o">.</span><span class="n">data</span><span class="o">=</span><span class="n">w_l</span><span class="p">[</span><span class="n">channel</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ic</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">w_in</span><span class="o">.</span><span class="n">data</span> <span class="o">*=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">autoencoder</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()[</span><span class="mi">1</span><span class="p">][</span><span class="n">channel</span><span class="p">])</span>
        <span class="n">plot_weights</span><span class="p">(</span><span class="n">w_in</span><span class="p">,</span><span class="n">layer</span><span class="o">=</span><span class="n">layer</span><span class="p">,</span><span class="n">channel</span><span class="o">=</span><span class="n">count</span><span class="p">,</span><span class="n">nchannels</span><span class="o">=</span><span class="mi">36</span><span class="p">,</span>
                     <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="c1"># Scatterplot of encoded v original</span>
<span class="n">ax</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.54</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.225</span><span class="p">,</span><span class="mf">0.4</span><span class="p">])</span>
<span class="n">aspect</span><span class="o">=.</span><span class="mi">225</span><span class="o">/.</span><span class="mi">4</span><span class="o">*</span><span class="mi">16</span><span class="o">/</span><span class="mi">9</span>
<span class="c1"># Axes ranges from data</span>
<span class="n">dmin</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">ic</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">pm</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
<span class="n">dmax</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">ic</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span><span class="n">pm</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<span class="n">dmean</span><span class="o">=</span><span class="p">(</span><span class="n">dmin</span><span class="o">+</span><span class="n">dmax</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
<span class="n">dmax</span><span class="o">=</span><span class="n">dmean</span><span class="o">+</span><span class="p">(</span><span class="n">dmax</span><span class="o">-</span><span class="n">dmean</span><span class="p">)</span><span class="o">*</span><span class="mf">1.05</span>
<span class="n">dmin</span><span class="o">=</span><span class="n">dmean</span><span class="o">-</span><span class="p">(</span><span class="n">dmean</span><span class="o">-</span><span class="n">dmin</span><span class="p">)</span><span class="o">*</span><span class="mf">1.05</span>
<span class="k">if</span> <span class="n">aspect</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">dmin</span><span class="o">/</span><span class="mi">100</span><span class="p">,</span><span class="n">dmax</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="n">dmean</span><span class="o">-</span><span class="p">(</span><span class="n">dmean</span><span class="o">-</span><span class="n">dmin</span><span class="p">)</span><span class="o">*</span><span class="n">aspect</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">,</span>
                <span class="p">(</span><span class="n">dmean</span><span class="o">+</span><span class="p">(</span><span class="n">dmax</span><span class="o">-</span><span class="n">dmean</span><span class="p">)</span><span class="o">*</span><span class="n">aspect</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">dmin</span><span class="o">/</span><span class="mi">100</span><span class="p">,</span><span class="n">dmax</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="n">dmean</span><span class="o">-</span><span class="p">(</span><span class="n">dmean</span><span class="o">-</span><span class="n">dmin</span><span class="p">)</span><span class="o">*</span><span class="n">aspect</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">,</span>
                <span class="p">(</span><span class="n">dmean</span><span class="o">+</span><span class="p">(</span><span class="n">dmax</span><span class="o">-</span><span class="n">dmean</span><span class="p">)</span><span class="o">*</span><span class="n">aspect</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">pm</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">/</span><span class="mi">100</span><span class="p">,</span>
           <span class="n">y</span><span class="o">=</span><span class="n">ic</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">/</span><span class="mi">100</span><span class="p">,</span>
           <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
           <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>
           <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span>
           <span class="n">s</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Original&#39;</span><span class="p">,</span> 
       <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Encoded&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
        <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> 
        <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="c1"># Plot the training history</span>
<span class="n">history_save_file</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/Machine-Learning-experiments/&quot;</span><span class="o">+</span>
                   <span class="s2">&quot;simple_autoencoder_instrumented/&quot;</span><span class="o">+</span>
                   <span class="s2">&quot;saved_models/history_to_</span><span class="si">%04d</span><span class="s2">.pkl&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span>
                          <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;SCRATCH&#39;</span><span class="p">),</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">history</span><span class="o">=</span><span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span> <span class="nb">open</span><span class="p">(</span> <span class="n">history_save_file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span> <span class="p">)</span> <span class="p">)</span>
<span class="n">ax</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.82</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.155</span><span class="p">,</span><span class="mf">0.4</span><span class="p">])</span>
<span class="c1"># Axes ranges from data</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Epochs of training&#39;</span><span class="p">,</span> 
       <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Loss&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
        <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> 
        <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">args</span><span class="o">.</span><span class="n">epoch</span><span class="p">])),</span>
        <span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">args</span><span class="o">.</span><span class="n">epoch</span><span class="p">],</span>
        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span>
        <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># Render the figure as a png</span>
<span class="n">figfile</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/Machine-Learning-experiments/&quot;</span><span class="o">+</span>
                   <span class="s2">&quot;simple_autoencoder_instrumented/&quot;</span><span class="o">+</span>
                   <span class="s2">&quot;images/comparison_</span><span class="si">%04d</span><span class="s2">.png&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span>
                          <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;SCRATCH&#39;</span><span class="p">),</span><span class="n">args</span><span class="o">.</span><span class="n">epoch</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">figfile</span><span class="p">)):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">figfile</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">figfile</span><span class="p">)</span>

</pre></div>
</div>
<p>To make the video, it is necessary to run the script above hundreds of times - giving an image after each epoch of training. This script makes the list of commands needed to make all the images, which can be run <a class="reference external" href="http://brohan.org/offline_assimilation/tools/parallel.html">in parallel</a>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="c1"># Make a comparison plot for each epoch 1-1000</span>
<span class="c1"># Actually make a list of commands to do that, </span>
<span class="c1">#              which can then be run in parallel.</span>


<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="c1"># Where to put the output files</span>
<span class="n">opdir</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/slurm_output&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;SCRATCH&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">opdir</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">opdir</span><span class="p">)</span>

<span class="c1"># Function to check if the job is already done for this epoch</span>
<span class="k">def</span> <span class="nf">is_done</span><span class="p">(</span><span class="n">epoch</span><span class="p">):</span>
    <span class="n">op_file_name</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/Machine-Learning-experiments/&quot;</span><span class="o">+</span>
                   <span class="s2">&quot;simple_autoencoder_instrumented/&quot;</span><span class="o">+</span>
                   <span class="s2">&quot;images/comparison_</span><span class="si">%04d</span><span class="s2">.png&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span>
                          <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;SCRATCH&#39;</span><span class="p">),</span><span class="n">epoch</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">op_file_name</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span>

<span class="n">f</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="s2">&quot;run.txt&quot;</span><span class="p">,</span><span class="s2">&quot;w+&quot;</span><span class="p">)</span>

<span class="n">epoch</span><span class="o">=</span><span class="mi">1</span>
<span class="k">while</span> <span class="n">epoch</span><span class="o">&lt;=</span><span class="mi">1000</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">is_done</span><span class="p">(</span><span class="n">epoch</span><span class="p">):</span>
        <span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">continue</span>
    <span class="n">cmd</span><span class="o">=</span><span class="s2">&quot;./compare_full.py --epoch=</span><span class="si">%d</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">epoch</span> 
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span>
<span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>



</pre></div>
</div>
<p>To turn the thousands of images into a movie, use <a class="reference external" href="http://www.ffmpeg.org">ffmpeg</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="n">ffmpeg</span> <span class="o">-</span><span class="n">r</span> <span class="mi">12</span> <span class="o">-</span><span class="n">pattern_type</span> <span class="n">glob</span> <span class="o">-</span><span class="n">i</span> <span class="o">/</span><span class="n">scratch</span><span class="o">/</span><span class="n">hadpb</span><span class="o">/</span><span class="n">Machine</span><span class="o">-</span><span class="n">Learning</span><span class="o">-</span><span class="n">experiments</span><span class="o">/</span><span class="n">simple_autoencoder_instrumented</span><span class="o">/</span><span class="n">images</span><span class="o">/</span><span class="n">comparison_</span>\<span class="o">*.</span><span class="n">png</span> <span class="o">-</span><span class="n">c</span><span class="p">:</span><span class="n">v</span> <span class="n">libx264</span> <span class="o">-</span><span class="n">preset</span> <span class="n">slow</span> <span class="o">-</span><span class="n">tune</span> <span class="n">animation</span> <span class="o">-</span><span class="n">profile</span><span class="p">:</span><span class="n">v</span> <span class="n">high</span> <span class="o">-</span><span class="n">level</span> <span class="mf">4.2</span> <span class="o">-</span><span class="n">pix_fmt</span> <span class="n">yuv420p</span> <span class="o">-</span><span class="n">crf</span> <span class="mi">25</span> <span class="o">-</span><span class="n">c</span><span class="p">:</span><span class="n">a</span> <span class="n">copy</span> <span class="n">full</span><span class="o">.</span><span class="n">mp4</span>

</pre></div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="comparison_video.html" title="Video diagnostics of model output"
             >next</a> |</li>
        <li class="right" >
          <a href="video.html" title="Generating video diagnostics"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">ML Experiments</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../perturbations.html" >Perturbing the simple autoencoder</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="video.html" >Generating video diagnostics</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    </div>
  </body>
</html>